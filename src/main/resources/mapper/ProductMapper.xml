<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.fullstack7.edusecond.edusecond.mapper.ProductMapper">
  <!--상품 조회, 등록, 수정, 삭제-->
  <select id="totalCount" parameterType="map" resultType="int">
    SELECT COUNT(productId) AS total_count
    FROM tbl_product
    <where>
      <if test="searchCategory != null and !searchCategory.trim().isEmpty() and searchValue != null and !searchValue.trim().isEmpty()">
        ${searchCategory} LIKE CONCAT('%', #{searchValue}, '%')
      </if>
    </where>
  </select>
  <select id="selectAllProducts" parameterType="map" resultType="net.fullstack7.edusecond.edusecond.domain.product.ProductVO">
    SELECT 
        p.productId,
        p.sellerId,
        p.productName,
        p.price,
        p.quantity,
        p.quality,
        p.productStatus,
        p.viewCount,
        p.regDate,
        p.modifyDate,
        m.userName as sellerName,
        (SELECT imagePath 
         FROM tbl_product_image 
         WHERE productId = p.productId 
         AND isMain = 'Y' 
         LIMIT 1) as thumbnailPath
    FROM tbl_product p
    LEFT JOIN tbl_member m ON p.sellerId = m.userId
    WHERE 1=1
    <if test="searchType != null and searchType == 'productName'">
        AND p.productName LIKE CONCAT('%', #{searchValue}, '%')
    </if>
    <if test="searchType != null and searchType == 'sellerId'">
        AND p.sellerId LIKE CONCAT('%', #{searchValue}, '%')
    </if>
    ORDER BY p.productId DESC
    LIMIT #{offset}, #{limit}
  </select>
  <select id="selectProductById" parameterType="java.lang.Integer" resultType="net.fullstack7.edusecond.edusecond.domain.product.ProductVO">
    SELECT 
        p.productId, 
        p.sellerId, 
        p.productName, 
        p.productDesc, 
        p.price, 
        p.quantity, 
        p.quality, 
        p.productStatus, 
        p.viewCount, 
        p.regDate, 
        p.modifyDate,
        m.userName as sellerName
    FROM tbl_product p
    LEFT JOIN tbl_member m ON p.sellerId = m.userId
    WHERE p.productId = #{productId}
  </select>

  <insert id="insertProduct" >
    INSERT INTO tbl_product (sellerId, productName, productDesc, price, quantity, quality)
    VALUES (#{sellerId}, #{productName}, #{productDesc}, #{price}, #{quantity}, #{quality});
  </insert>
  <insert id="insertProductImageMain">
    INSERT INTO tbl_product_image (productId, imagePath, isMain)
    VALUES ( #{productId}, #{imagePath}, 'Y')
  </insert>
  <insert id="insertProductImage">
    INSERT INTO tbl_product_image (productId, imagePath)
    VALUES ( #{productId}, #{imagePath})
  </insert>
  <select id="getLastProductId" resultType="java.lang.Integer">
    SELECT productId
    FROM tbl_product
    ORDER BY regDate DESC
    LIMIT 1
  </select>
  <!--위시리스트 조회, 추가, 삭제-->
  <!--주문 조회, 등록, 수정, 삭제-->
  <!--리뷰 조회, 등록, 수정, 삭제-->
  <select id="selectThumbnailImage" resultType="net.fullstack7.edusecond.edusecond.domain.product.ProductImageVO">
    SELECT 
        imageId,
        productId,
        imagePath,
        isMain
    FROM tbl_product_image
    WHERE productId = #{productId}
    AND isMain = 'Y'
    LIMIT 1
  </select>
  <select id="selectProductImages" resultType="net.fullstack7.edusecond.edusecond.domain.product.ProductImageVO">
    SELECT 
        imageId,
        productId,
        imagePath,
        isMain
    FROM tbl_product_image
    WHERE productId = #{productId}
    ORDER BY isMain DESC, imageId ASC
  </select>
  <update id="updateViewCount">
    UPDATE tbl_product 
    SET viewCount = viewCount + 1 
    WHERE productId = #{productId}
  </update>
</mapper>