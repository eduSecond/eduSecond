<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.fullstack7.edusecond.edusecond.mapper.ChatMapper">
    
    <!-- 채팅방 목록 조회 -->
    <select id="selectChatRoomList" resultType="net.fullstack7.edusecond.edusecond.dto.message.ChatRoomDTO">
        SELECT 
            c.*, p.productName,
            m.userName as otherUserName,
            (SELECT COUNT(*) FROM tbl_chat_message 
             WHERE roomId = c.roomId AND isRead = 'N' 
             AND senderId != #{userId}) as unreadCount
        FROM tbl_chatroom c
        JOIN tbl_product p ON c.productId = p.productId
        JOIN tbl_member m ON CASE 
            WHEN c.sellerId = #{userId} THEN m.userId = c.buyerId
            ELSE m.userId = c.sellerId
        END
        WHERE (c.sellerId = #{userId} OR c.buyerId = #{userId})
        AND c.isActive = 'Y'
        ORDER BY c.regDate DESC
    </select>

    <!-- 채팅방 단일 조회 -->
    <select id="selectChatRoom" resultType="net.fullstack7.edusecond.edusecond.domain.message.ChatRoomVO">
        SELECT * FROM tbl_chatroom
        WHERE roomId = #{roomId}
    </select>

    <!-- 채팅방 생성 -->
    <insert id="insertChatRoom" parameterType="net.fullstack7.edusecond.edusecond.domain.message.ChatRoomVO">
        INSERT INTO tbl_chatroom (productId, sellerId, buyerId, isActive)
        VALUES (#{productId}, #{sellerId}, #{buyerId}, 'Y')
    </insert>

    <!-- 채팅 메시지 목록 조회 -->
    <select id="selectChatMessages" resultType="net.fullstack7.edusecond.edusecond.domain.message.ChatMessageVO">
        SELECT * FROM tbl_chat_message
        WHERE roomId = #{roomId}
        ORDER BY regDate ASC
    </select>

    <!-- 메시지 저장 -->
    <insert id="insertMessage" parameterType="net.fullstack7.edusecond.edusecond.domain.message.ChatMessageVO">
        INSERT INTO tbl_chat_message (roomId, senderId, message, isRead)
        VALUES (#{roomId}, #{senderId}, #{message}, 'N')
    </insert>

    <!-- 메시지 읽음 처리 -->
    <update id="updateMessageRead">
        UPDATE tbl_chat_message
        SET isRead = 'Y'
        WHERE roomId = #{roomId}
        AND senderId != #{userId}
        AND isRead = 'N'
    </update>
    <!--채팅방 상태 업데이트(비활성화)-->
    <update id="updateChatRoomStatus">
        UPDATE tbl_chatroom
        SET isActive = 'N'
        WHERE roomId = #{roomId}
    </update>
</mapper>
